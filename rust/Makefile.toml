# Cargo Make entrypoint for the Exercism Rust collection.
# Tasks are split into domain-specific files under contrib/cargo-make/ to keep them readable.

extend = [
  { path = "contrib/cargo-make/init/Makefile.toml" },
  { path = "contrib/cargo-make/core/Makefile.toml" },
  { path = "contrib/cargo-make/fmt/Makefile.toml" },
  { path = "contrib/cargo-make/build/Makefile.toml" },
  { path = "contrib/cargo-make/test/Makefile.toml" },
  { path = "contrib/cargo-make/clippy/Makefile.toml" },
  { path = "contrib/cargo-make/clean/Makefile.toml" },
  { path = "contrib/cargo-make/doc/Makefile.toml" },
  { path = "contrib/cargo-make/fix/Makefile.toml" },
  { path = "contrib/cargo-make/validation/Makefile.toml" },
  { path = "contrib/cargo-make/packaging/Makefile.toml" },
]

[config]
# Keep execution single-run; tasks themselves handle workspace fan-out.
default_to_workspace = false
skip_core_tasks = true
# Avoid double-running init; tasks depend on it explicitly.
init_task = "empty"

[env]
# Common arguments - can be overridden
MESSAGE_FORMAT = { value = "--message-format=short", condition = { env_not_set = ["MESSAGE_FORMAT"] } }
ALL_FEATURES   = { value = "",       condition = { env_not_set = ["ALL_FEATURES"] } }
ALL_TARGETS    = { value = "--all-targets",         condition = { env_not_set = ["ALL_TARGETS"] } }
FEATURES = { value = "", condition = { env_not_set = ["FEATURES"] } }

# Build configuration
RELEASE = { value = "0", condition = { env_not_set = ["RELEASE"] } }
STRICT  = { value = "0", condition = { env_not_set = ["STRICT"] } }

# Clippy settings
CLIPPY_BASE_ARGS = { value = "-D warnings", condition = { env_not_set = ["CLIPPY_BASE_ARGS"] } }
STRICT_CLIPPY_DENY = { value = "--deny warnings --deny clippy::pedantic --deny clippy::nursery", condition = { env_not_set = ["STRICT_CLIPPY_DENY"] } }
STRICT_CLIPPY_ALLOW = { value = "--allow clippy::wildcard_imports --allow clippy::used_underscore_binding --allow clippy::missing_docs_in_private_items --allow clippy::missing_panics_doc --allow clippy::missing_errors_doc --allow clippy::missing_safety_doc --allow clippy::doc_markdown", condition = { env_not_set = ["STRICT_CLIPPY_ALLOW"] } }

# Distribution settings
DIST_DIR = { value = "dist", condition = { env_not_set = ["DIST_DIR"] } }

# Workspace convenience flag
WORKSPACE_FLAG = { value = "--workspace", condition = { env_not_set = ["WORKSPACE_FLAG"] } }

# Utility Tasks (centralized)

[tasks.list_members]
description = "List all workspace members"
category = "Tools"
script_runner = "@duckscript"
script = '''
#!@duckscript
echo Workspace members:
handle = glob_array */Cargo.toml
for path in ${handle}
    dir = dirname ${path}
    if not equals ${dir} "."
        echo "  - ${dir}"
    end
end
'''

[tasks.list_targets]
description = "List all configured targets"
category = "Tools"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
targets = get_env TARGETS
target_list = split ${targets} " "
echo "Configured targets:"
for target in ${target_list}
    target = trim ${target}
    if not is_empty ${target}
        echo "  - ${target}"
    end
end
'''

# Developer Shortcuts

[tasks.quick]
description = "Quick build and test for current crate"
category = "Development"
dependencies = ["format", "build", "test"]

[tasks.quick_all]
description = "Quick build and test across the workspace"
category = "Development"
dependencies = ["format_all", "build_all", "test_all"]

[tasks.release]
description = "Build optimized release binary for host"
category = "Build"
dependencies = ["init"]
command = "cargo"
args = ["build", "--release"]

[tasks.release_targets]
description = "Build optimized release binaries for all targets"
category = "Build"
env = { "RELEASE" = "1" }
dependencies = ["build_targets"]

[tasks.dist]
description = "Build and package release binaries for all targets"
category = "Build"
env = { "RELEASE" = "1" }
dependencies = ["package_targets"]
condition = { env_set = ["MEMBER"] }
