
[tasks.fix]
description = "Run cargo fix for current crate"
category = "Development"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "fix"

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--allow-dirty"

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''
[tasks.clean]
description = "Clean build artifacts for the current crate"
category = "Build"
command = "cargo"
args = ["clean"]

[tasks.doc]
description = "Generate documentation (no deps) for the current crate. In workspaces, either run from the crate dir or use workspace doc."
category = "Documentation"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "doc"

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--no-deps"

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

# Workspace-wide utilities

[tasks.clean_workspace]
description = "Clean all workspace members"
category = "Build"
command = "cargo"
args = ["clean"]

[tasks.doc_workspace]
description = "Generate documentation for all workspace members"
category = "Documentation"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "doc"
array_push ${args} ${WORKSPACE_FLAG}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--no-deps"

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.fix_all]
description = "Run cargo fix on all workspace members"
category = "Development"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "fix"
array_push ${args} ${WORKSPACE_FLAG}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--allow-dirty"

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''
