#  ╭──────────────────────────────────────────────────────────╮
#  │                   Workspace-Wide Tasks                   │
#  ╰──────────────────────────────────────────────────────────╯

[tasks.clean]
description = "Clean all workspace members"
category = "Build"
command = "cargo"
args = ["clean"]

[tasks.doc]
description = "Generate documentation for all workspace members"
category = "Documentation"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "doc"
array_push ${args} ${WORKSPACE_FLAG}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--no-deps"

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.build_all]
description = "Build all workspace members for host target"
category = "Build"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "build"
array_push ${args} ${WORKSPACE_FLAG}

cargo_args = get_env CARGO_BUILD_ARGS
if not is_empty ${cargo_args}
    parts = split ${cargo_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.test_all]
description = "Run tests for all workspace members on host target"
category = "Test"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "test"
array_push ${args} ${WORKSPACE_FLAG}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.check_all]
description = "Run cargo check on all workspace members for host target"
category = "Build"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "check"
array_push ${args} ${WORKSPACE_FLAG}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.clippy_all]
description = "Run clippy on all workspace members for host target"
category = "Build"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "clippy"
array_push ${args} ${WORKSPACE_FLAG}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

all_targets = get_env ALL_TARGETS
if not is_empty ${all_targets}
    parts = split ${all_targets} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--"
clippy_args = get_env CLIPPY_ARGS
if not is_empty ${clippy_args}
    parts = split ${clippy_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.format_all]
description = "Check formatting for all workspace members"
category = "Development"
command = "cargo"
args = ["fmt", "${WORKSPACE_FLAG}", "--", "--check"]

[tasks.format_fix_all]
description = "Fix formatting for all workspace members"
category = "Development"
command = "cargo"
args = ["fmt", "${WORKSPACE_FLAG}"]

[tasks.fix_all]
description = "Run cargo fix on all workspace members"
category = "Development"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
args = array
array_push ${args} "fix"
array_push ${args} ${WORKSPACE_FLAG}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--allow-dirty"

args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

#  ╭──────────────────────────────────────────────────────────╮
#  │              Per-Member Tasks (Host Only)                │
#  ╰──────────────────────────────────────────────────────────╯

[tasks.build_member]
description = "Build a specific workspace member (use with MEMBER=<name>)"
category = "Build"
condition = { env_set = ["MEMBER"] }
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
member = get_env MEMBER
args = array
array_push ${args} "build"
array_push ${args} "-p"
array_push ${args} ${member}

cargo_args = get_env CARGO_BUILD_ARGS
if not is_empty ${cargo_args}
    parts = split ${cargo_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

echo "Building member: ${member}"
args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.test_member]
description = "Test a specific workspace member (use with MEMBER=<name>)"
category = "Test"
condition = { env_set = ["MEMBER"] }
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
member = get_env MEMBER
args = array
array_push ${args} "test"
array_push ${args} "-p"
array_push ${args} ${member}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

echo "Testing member: ${member}"
args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.check_member]
description = "Check a specific workspace member (use with MEMBER=<name>)"
category = "Build"
condition = { env_set = ["MEMBER"] }
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
member = get_env MEMBER
args = array
array_push ${args} "check"
array_push ${args} "-p"
array_push ${args} ${member}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

echo "Checking member: ${member}"
args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.clippy_member]
description = "Run clippy on a specific workspace member (use with MEMBER=<name>)"
category = "Build"
condition = { env_set = ["MEMBER"] }
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
member = get_env MEMBER
args = array
array_push ${args} "clippy"
array_push ${args} "-p"
array_push ${args} ${member}

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

all_targets = get_env ALL_TARGETS
if not is_empty ${all_targets}
    parts = split ${all_targets} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

message_format = get_env MESSAGE_FORMAT
if not is_empty ${message_format}
    parts = split ${message_format} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

array_push ${args} "--"
clippy_args = get_env CLIPPY_ARGS
if not is_empty ${clippy_args}
    parts = split ${clippy_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

echo "Running clippy on member: ${member}"
args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

[tasks.run_member]
description = "Run a specific workspace member binary (use with MEMBER=<name>)"
category = "Development"
condition = { env_set = ["MEMBER"] }
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
member = get_env MEMBER
args = array
array_push ${args} "run"
array_push ${args} "-p"
array_push ${args} ${member}

cargo_args = get_env CARGO_BUILD_ARGS
if not is_empty ${cargo_args}
    parts = split ${cargo_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

feature_args = get_env FEATURE_ARGS
if not is_empty ${feature_args}
    parts = split ${feature_args} " "
    for p in ${parts}
        p = trim ${p}
        if not is_empty ${p}
            array_push ${args} ${p}
        end
    end
end

echo "Running member: ${member}"
args_string = array_join ${args} " "
exec --fail-on-error cargo %{args_string}
'''

#  ╭──────────────────────────────────────────────────────────╮
#  │                    Utility Tasks                         │
#  ╰──────────────────────────────────────────────────────────╯

[tasks.list_members]
description = "List all workspace members"
category = "Tools"
script_runner = "@duckscript"
script = '''
#!@duckscript
echo Workspace members:
handle = glob_array */Cargo.toml
for path in ${handle}
    dir = dirname ${path}
    if not equals ${dir} "."
        echo "  - ${dir}"
    end
end
'''

[tasks.list_targets]
description = "List all configured targets"
category = "Tools"
dependencies = ["init"]
script_runner = "@duckscript"
script = '''
#!@duckscript
targets = get_env TARGETS
target_list = split ${targets} " "
echo "Configured targets:"
for target in ${target_list}
    target = trim ${target}
    if not is_empty ${target}
        echo "  - ${target}"
    end
end
'''
